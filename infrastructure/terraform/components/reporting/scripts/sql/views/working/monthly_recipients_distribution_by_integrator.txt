SELECT
    createdMonth,
    clientid,
    messagesDelivered AS totalMessagesByIntegrator,
    COUNT(DISTINCT nhsnumberhash) AS countOfRecipients
FROM (
    SELECT
        createdMonth,
        clientid,
        nhsnumberhash,
        COUNT(*) AS messagesDelivered
    FROM vw_monthly_delivered_messages
    GROUP BY 1, 2, 3
)
GROUP BY 1, 2, 3
