WITH base AS (
    SELECT
        DATE(DATE_TRUNC('month', createdtime)) AS createdMonth,
        communicationType,
        nhsnumberhash
    FROM request_item_status
    CROSS JOIN UNNEST(completedcommunicationtypes) AS t(communicationType)
    WHERE status = 'DELIVERED'
),
monthly_recipient_counts AS (
    SELECT
        createdMonth,
        COUNT(DISTINCT nhsnumberhash) AS totalMonthlyRecipients
    FROM base
    GROUP BY 1
),
message_counts AS (
    SELECT
        createdMonth,
        communicationType,
        COUNT(*) AS messagesDelivered
    FROM base
    GROUP BY 1, 2
)

SELECT
    m.createdMonth,
    m.communicationType,
    r.totalMonthlyRecipients,
    m.messagesDelivered,
    (m.messagesDelivered * 1.0) / (r.totalMonthlyRecipients * 1.0) AS messagePerOverallRecipient
FROM message_counts m
JOIN monthly_recipient_counts r
    ON m.createdMonth = r.createdMonth
