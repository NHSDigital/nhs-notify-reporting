WITH message_counts AS (
    SELECT
        createdMonth,
        communicationType,
        COUNT(*) AS messagesDelivered
    FROM vw_monthly_delivered_messages
    GROUP BY 1, 2
),
monthly_recipient_counts AS (
    SELECT
        createdMonth,
        COUNT(DISTINCT nhsnumberhash) AS totalMonthlyRecipients
    FROM vw_monthly_delivered_messages
    GROUP BY 1
)

SELECT
    m.createdMonth,
    m.communicationType,
    r.totalMonthlyRecipients,
    m.messagesDelivered,
    (m.messagesDelivered * 1.0) / (r.totalMonthlyRecipients * 1.0) AS messagePerOverallRecipient
FROM message_counts m
JOIN monthly_recipient_counts r
    ON m.createdMonth = r.createdMonth
